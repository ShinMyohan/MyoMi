<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!-- SQL definition -->
<mapper namespace="ReviewMapper">
	<!-- 베스트리뷰 상세조회 -->
	<select id="selectOneBestReview" resultType="map">
		SELECT
		r.*, p.name from best_review br
		right join review r ON br.review_num = r.num
		JOIN orders_detail od ON r.order_num = od.order_num
		JOIN product p ON p.num = od.prod_num
		WHERE r.num=#{review.num}
	</select>
	<!-- 리뷰 전체조회 -->
	<select id="selectAll" parameterType="int" resultType="Map">
		SELECT
		r.num,r.order_num,r.user_id,r.sort,r.title,r.content,r.created_date,r.stars,p.name
		FROM review r,orders_detail od,product p
		WHERE r.order_num=od.order_num
		AND
		od.prod_num=p.num
		AND p.num=#{num}
	</select>
	<!-- 리뷰 최신순 전체조회 -->
	<select id="selectAllByDate" parameterType="int"
		resultType="Map">
		SELECT
		r.num,r.order_num,r.user_id,r.sort,r.title,r.content,r.created_date,r.stars,p.name
		FROM review r,orders_detail od,product p
		WHERE r.order_num=od.order_num
		AND
		od.prod_num=p.num
		AND p.num=#{num}
		ORDER BY
		created_date desc
	</select>
	<!-- 리뷰 별점순 전체조회 -->
	<select id="selectAllByStars" parameterType="int"
		resultType="Map">
		SELECT
		r.num,r.order_num,r.user_id,r.sort,r.title,r.content,r.created_date,r.stars,p.name
		from review r,orders_detail od,product p
		WHERE r.order_num=od.order_num
		AND
		od.prod_num=p.num
		AND p.num=#{num}
		ORDER BY r.stars
		DESC
	</select>
	<!-- 주문번호로 리뷰조회 -->
	<select id="selectOneReviewByOrder" parameterType="int"
		resultType="Map">
		SELECT
		r.num,r.order_num "주문번호",r.user_id
		"아이디",r.sort,r.title,r.content,r.created_date,r.stars,p.name
		FROM
		review r,orders_detail od,product p
		WHERE r.order_num=od.order_num
		AND
		od.prod_num=p.num
		AND r.order_num = #{order.num}
	</select>
	<!-- 리뷰 상세조회 -->
	<select id="selectOneReview" parameterType="int"
		resultType="Map">
		SELECT
		r.num,r.order_num "주문번호",r.user_id
		"아이디",r.sort,r.title,r.content,r.created_date,r.stars,p.name
		FROM
		review r,orders_detail od,product p
		WHERE r.order_num=od.order_num
		AND
		od.prod_num=p.num
		AND r.num = #{review.num}
	</select>
	<!-- 이번달 베스트 리뷰 목록 조회 -->
	<select id="selectBestReviewByMonth" parameterType="int"
		resultType="Map">
		SELECT
		r.*, br.created_date as best_review_date,p.name from best_review br,
		review r ,orders_detail od ,product p
		WHERE br.review_num = r.num
		AND r.order_num=od.order_num
		AND p.num=od.prod_num
		AND od.prod_num=#{product.num} AND
		br.created_date
		BETWEEN (SELECT to_char(sysdate, 'yyyy-mm') || '-01' AS 이번달시작일 FROM dual)
		AND (SELECT to_char(LAST_DAY(sysdate), 'yyyy-mm-dd') AS 이번달마지막일 FROM
		dual)
	</select>

	<!-- 리뷰작성 -->
	<insert id="insertReview" parameterType="Review"
		keyProperty="id">
		INSERT INTO review VALUES(seq_review.nextval,
		#{order.num},
		#{user.id}, #{sort}, #{title},
		#{content},sysdate,#{stars})

	</insert>

	<!-- 베스트리뷰 선정 -->
	<insert id="insertBestReview" parameterType="BestReview"
		keyProperty="review_num">
		INSERT INTO Best_Review VALUES (#{review.num}, sysdate)
	</insert>

	<!-- 리뷰 목록 최신순조회(sort로 일반, 포토구분) -->
	<select id="selectReviewByDate" parameterType="Review"
		resultType="Map">
		SELECT
		r.num,r.order_num,r.user_id,r.sort,r.title,r.content,r.created_date,r.stars,p.name
		FROM review r,orders_detail od,product p
		WHERE r.order_num=od.order_num
		AND
		od.prod_num=p.num
		AND sort=#{sort}
		AND p.num=#{num}
		ORDER BY
		created_date desc
	</select>
	<!-- 리뷰 목록 별점순 조회 (sort로 일반, 포토구분) -->
	<select id="selectReviewByStars" parameterType="Review"
		resultType="Map">
		SELECT
		r.num,r.order_num,r.user_id,r.sort,r.title,r.content,r.created_date,r.stars,p.name
		FROM review r,orders_detail od,product p
		WHERE r.order_num=od.order_num
		AND
		od.prod_num=p.num
		AND sort=#{sort}
		AND p.num=#{num}
		ORDER BY r.stars
		DESC
	</select>
	<!-- 리뷰 수정 -->
	<update id="updateReview" parameterType="map" keyProperty="id">
		UPDATE
		review set title=#{title} , content = #{content}
		WHERE num
		=#{num}
	</update>

</mapper>

